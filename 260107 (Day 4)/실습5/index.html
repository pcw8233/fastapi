<!doctype html>
<html>
    <head>
        <title>OZ 실시간 채팅방</title>
        <style>
            body {
                font-family: "Pretendard", sans-serif;
                background: #abc1d1;
                display: flex;
                justify-content: center;
                padding: 20px;
                margin: 0;
            }
            .chat-container {
                width: 400px;
                height: 600px;
                background: #abc1d1;
                display: flex;
                flex-direction: column;
            }
            #chat-log {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            /* 말풍선 기본 스타일 */
            .msg {
                max-width: 70%;
                padding: 8px 12px;
                border-radius: 15px;
                font-size: 0.9rem;
                position: relative;
                word-break: break-all;
            }

            /* 상대방 메시지 (왼쪽) */
            .other {
                align-self: flex-start;
                background: white;
                border-top-left-radius: 0;
            }
            .sender-name {
                font-size: 0.75rem;
                color: #444;
                margin-bottom: 3px;
                margin-left: 2px;
            }

            /* 내 메시지 (오른쪽) */
            .mine {
                align-self: flex-end;
                background: #fee500;
                border-top-right-radius: 0;
            }

            /* 시스템 메시지 (중앙) */
            .system {
                align-self: center;
                background: rgba(0, 0, 0, 0.1);
                color: white;
                font-size: 0.75rem;
                border-radius: 20px;
                padding: 5px 15px;
            }

            .input-area {
                background: white;
                padding: 15px;
                display: flex;
                gap: 5px;
            }
            input {
                flex: 1;
                border: 1px solid #ddd;
                padding: 10px;
                border-radius: 5px;
                outline: none;
            }
            button {
                background: #fee500;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
            }
            #setup {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10;
            }
        </style>
    </head>
    <body>
        <div class="chat-container">
            <div id="setup">
                <h3>대화명을 입력하세요</h3>
                <input
                    type="text"
                    id="nickname"
                    style="flex: none; width: 200px; margin-bottom: 10px"
                />
                <button onclick="connect()" style="width: 220px">
                    입장하기
                </button>
            </div>

            <div id="chat-log"></div>
            <div class="input-area">
                <input
                    type="text"
                    id="message"
                    placeholder="메시지 입력..."
                    onkeypress="if(event.key==='Enter') send()"
                />
                <button onclick="send()">전송</button>
            </div>
        </div>

        <script>
            let ws;
            let myName;

            function connect() {
                myName = document.getElementById("nickname").value;
                if (!myName) return alert("이름을 입력하세요!");

                ws = new WebSocket(`ws://localhost:8000/ws/chat/${myName}`);
                ws.onopen = () =>
                    (document.getElementById("setup").style.display = "none");

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const log = document.getElementById("chat-log");
                    const wrapper = document.createElement("div");
                    wrapper.style.display = "flex";
                    wrapper.style.flexDirection = "column";

                    if (data.type === "system") {
                        const el = document.createElement("div");
                        el.className = "msg system";
                        el.innerText = data.message;
                        log.appendChild(el);
                    } else {
                        if (data.sender !== myName) {
                            const name = document.createElement("div");
                            name.className = "sender-name";
                            name.innerText = data.sender;
                            wrapper.appendChild(name);
                        }
                        const msg = document.createElement("div");
                        msg.className =
                            "msg " +
                            (data.sender === myName ? "mine" : "other");
                        msg.innerText = data.message;
                        wrapper.appendChild(msg);
                        log.appendChild(wrapper);
                    }
                    log.scrollTop = log.scrollHeight;
                };
            }

            function send() {
                const input = document.getElementById("message");
                if (input.value) {
                    ws.send(input.value);
                    input.value = "";
                }
            }
        </script>
    </body>
</html>
